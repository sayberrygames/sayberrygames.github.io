import{a as O,b as B,u as G,i as V,h as W,r as c,s as j,j as e}from"./index-BN_gJ3v_.js";import{S as H}from"./SEO-CrIi4KQH.js";import{S as J,N as K}from"./NotionEditor-DYQdOt-W.js";import{M as Q}from"./MarkdownViewer-DaVgTIq-.js";import{T as X}from"./trash-2-CJmMt8O-.js";import{E as Y}from"./eye-Cwf0cw50.js";const le=()=>{const{user:l,isAdmin:u,isTeamMember:w,userRole:f}=O(),h=B(),{language:g}=G(),{id:i}=V(),[L]=W(),o=L.get("type")||"dev_notes",[d,C]=c.useState("ko"),[y,S]=c.useState(!1),[v,x]=c.useState(!1),[N,m]=c.useState(""),[D,F]=c.useState([]),[p,q]=c.useState(""),[r,P]=c.useState({id:"",slug:"",title_ko:"",title_en:"",title_ja:"",excerpt_ko:"",excerpt_en:"",excerpt_ja:"",content_ko:"",content_en:"",content_ja:"",date:"",category:"",author:"",featured_image:"",steam_link:"",tags:[],published:!0,project_id:""}),s={ko:{title:o==="news"?"뉴스 수정":"개발 노트 수정",delete:"삭제",deleteConfirm:"정말로 이 게시물을 삭제하시겠습니까?",slug:"URL 슬러그 (영문, 숫자, 하이픈만)",titleLabel:"제목",excerptLabel:"요약 (선택사항)",contentLabel:"내용",date:"날짜",category:"카테고리",author:"작성자",featuredImage:"대표 이미지 URL (선택사항)",steamLink:"Steam 링크 (선택사항)",tags:"태그 (쉼표로 구분)",published:"공개",project:"프로젝트",selectProject:"프로젝트를 선택하세요",submit:"저장",cancel:"취소",preview:"미리보기",edit:"편집",error:"저장에 실패했습니다.",unauthorized:"권한이 없습니다.",requiredFields:"필수 입력 항목을 모두 작성해주세요.",notFound:"게시물을 찾을 수 없습니다."},en:{title:o==="news"?"Edit News":"Edit Development Note",delete:"Delete",deleteConfirm:"Are you sure you want to delete this post?",slug:"URL Slug (letters, numbers, hyphens only)",titleLabel:"Title",excerptLabel:"Excerpt (Optional)",contentLabel:"Content",date:"Date",category:"Category",author:"Author",featuredImage:"Featured Image URL (Optional)",steamLink:"Steam Link (Optional)",tags:"Tags (comma separated)",published:"Published",project:"Project",selectProject:"Select a project",submit:"Save",cancel:"Cancel",preview:"Preview",edit:"Edit",error:"Failed to save.",unauthorized:"Unauthorized.",requiredFields:"Please fill in all required fields.",notFound:"Post not found."},ja:{title:o==="news"?"ニュース編集":"開発ノート編集",delete:"削除",deleteConfirm:"本当にこの投稿を削除しますか？",slug:"URLスラッグ（英数字とハイフンのみ）",titleLabel:"タイトル",excerptLabel:"要約（オプション）",contentLabel:"内容",date:"日付",category:"カテゴリー",author:"著者",featuredImage:"アイキャッチ画像URL（オプション）",steamLink:"Steamリンク（オプション）",tags:"タグ（カンマ区切り）",published:"公開",project:"プロジェクト",selectProject:"プロジェクトを選択してください",submit:"保存",cancel:"キャンセル",preview:"プレビュー",edit:"編集",error:"保存に失敗しました。",unauthorized:"権限がありません。",requiredFields:"必須項目をすべて入力してください。",notFound:"投稿が見つかりません。"}}[g];c.useEffect(()=>{i&&(console.log("EditPost: Loading post with ID:",i),U(),I())},[i]);const U=async()=>{try{const{data:t,error:a}=await j.from(o).select("*").eq("id",i).single();if(a)throw a;t&&(console.log("EditPost: Loaded post data:",t),console.log("EditPost: Post author:",t.author),console.log("EditPost: Current user email:",l==null?void 0:l.email),console.log("EditPost: Is admin:",u),P({...t,tags:t.tags||[]}),q(t.author),console.log("EditPost: formData after loading:",{...t,tags:t.tags||[]}))}catch(t){console.error("Error fetching post:",t),m(s.notFound)}},I=async()=>{try{const{data:t,error:a}=await j.from("projects").select("*").eq("active",!0).order("sort_order");if(a)throw a;F(t||[])}catch(t){console.error("Error fetching projects:",t)}},k=()=>{var t,a;return l?u?!0:o==="dev_notes"&&w?p===((t=l.email)==null?void 0:t.split("@")[0])||p===((a=l.user_metadata)==null?void 0:a.name):o==="news"?f==="lead":!1:!1},T=()=>u;if(!k()&&r.id)return console.log("EditPost: Permission check failed",{user:l==null?void 0:l.email,isAdmin:u,isTeamMember:w,userRole:f,originalAuthor:p,formDataId:r.id,canEdit:k()}),e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-red-500 text-xl mb-4",children:s.unauthorized}),e.jsx("button",{onClick:()=>h(-1),className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-md text-white",children:s.cancel})]})});const R=async t=>{if(t.preventDefault(),!r.slug||!r.title_ko||!r.title_en||!r.title_ja||!r.content_ko||!r.content_en||!r.content_ja){m(s.requiredFields);return}x(!0),m("");try{const a=r.tags.length>0?r.tags.join(",").split(",").map(M=>M.trim()).filter(Boolean):[],{id:b,...z}=r,E={...z,tags:a};console.log("EditPost: Updating post with ID:",i),console.log("EditPost: Update data:",E);const{error:_}=await j.from(o).update(E).eq("id",i);if(_)throw _;h(o==="news"?"/news":"/devnotes")}catch(a){console.error("Error updating post:",a),m(s.error)}finally{x(!1)}},A=async()=>{if(window.confirm(s.deleteConfirm)){x(!0);try{console.log("EditPost: Deleting post with ID:",i),console.log("EditPost: Post type:",o),console.log("EditPost: Current user:",l==null?void 0:l.email),console.log("EditPost: User role:",f),console.log("EditPost: Is admin:",u),console.log("EditPost: Post author:",p);const{data:t,error:a,count:b}=await j.from(o).delete().eq("id",i).select();if(console.log("EditPost: Delete response - data:",t,"error:",a,"count:",b),a)throw console.error("EditPost: Delete error details:",{message:a.message,details:a.details,hint:a.hint,code:a.code}),a;if(!t||t.length===0){console.warn("EditPost: Delete returned no data - post may not have been deleted due to RLS policies"),m("삭제 권한이 없거나 RLS 정책에 의해 삭제가 제한되었습니다.");return}console.log("EditPost: Post deleted successfully"),h(o==="news"?"/news":"/devnotes")}catch(t){console.error("Error deleting post:",t),m(s.error)}finally{x(!1)}}},n=(t,a)=>{P(b=>({...b,[t]:a}))},$=o==="news"?["Announcement","Update","Event","Release","Partnership"]:["Development","Update","Feature","Announcement","Milestone","Technical","Team"];return e.jsxs(e.Fragment,{children:[e.jsx(H,{title:s.title+" | SayBerry Games"}),e.jsx("div",{className:"min-h-screen py-20 px-4",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold",children:s.title}),T()&&e.jsxs("button",{onClick:A,disabled:v,className:"flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-white transition-colors disabled:opacity-50",children:[e.jsx(X,{className:"h-5 w-5"}),s.delete]})]}),e.jsxs("form",{onSubmit:R,className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-900 p-6 rounded-lg space-y-4",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"기본 정보"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:[s.slug," *"]}),e.jsx("input",{type:"text",value:r.slug,onChange:t=>n("slug",t.target.value.toLowerCase().replace(/[^a-z0-9-]/g,"-")),required:!0,className:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white",pattern:"[a-z0-9\\-]+"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:[s.date," *"]}),e.jsx("input",{type:"date",value:r.date,onChange:t=>n("date",t.target.value),required:!0,className:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:[s.category," *"]}),e.jsx("select",{value:r.category,onChange:t=>n("category",t.target.value),className:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white",children:$.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:[s.author," *"]}),e.jsx("input",{type:"text",value:r.author,onChange:t=>n("author",t.target.value),required:!0,className:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:s.tags}),e.jsx("input",{type:"text",value:r.tags.join(", "),onChange:t=>n("tags",t.target.value.split(",").map(a=>a.trim())),className:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white",placeholder:"tag1, tag2, tag3"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:s.featuredImage}),e.jsx("input",{type:"url",value:r.featured_image||"",onChange:t=>n("featured_image",t.target.value),className:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:s.steamLink}),e.jsx("input",{type:"url",value:r.steam_link||"",onChange:t=>n("steam_link",t.target.value),className:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white"})]})]}),o==="dev_notes"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:[s.project," *"]}),e.jsxs("select",{value:r.project_id,onChange:t=>n("project_id",t.target.value),required:!0,className:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white",children:[e.jsx("option",{value:"",children:s.selectProject}),D.map(t=>e.jsx("option",{value:t.id,children:g==="ko"?t.name_ko:g==="ja"?t.name_ja:t.name_en},t.id))]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:r.published,onChange:t=>n("published",t.target.checked),className:"mr-2",id:"published"}),e.jsx("label",{htmlFor:"published",children:s.published})]})]}),e.jsxs("div",{className:"bg-gray-900 p-6 rounded-lg",children:[e.jsxs("div",{className:"flex space-x-4 mb-6 border-b border-gray-700",children:[["ko","en","ja"].map(t=>e.jsx("button",{type:"button",onClick:()=>C(t),className:`pb-2 px-4 ${d===t?"border-b-2 border-blue-500 text-blue-500":"text-gray-400 hover:text-white"}`,children:t==="ko"?"한국어":t==="en"?"English":"日本語"},t)),e.jsx("div",{className:"flex-1"}),e.jsx("button",{type:"button",onClick:()=>S(!y),className:"flex items-center space-x-2 text-gray-400 hover:text-white",children:y?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx("span",{children:s.edit})]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4"}),e.jsx("span",{children:s.preview})]})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:[s.titleLabel," *"]}),e.jsx("input",{type:"text",value:r[`title_${d}`]||"",onChange:t=>n(`title_${d}`,t.target.value),required:!0,className:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:s.excerptLabel}),e.jsx("textarea",{value:r[`excerpt_${d}`]||"",onChange:t=>n(`excerpt_${d}`,t.target.value),rows:3,className:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:[s.contentLabel," *"]}),y?e.jsx("div",{className:"bg-gray-800 p-4 rounded-lg min-h-[500px]",children:e.jsx(Q,{content:r[`content_${d}`]})}):e.jsx(K,{content:r[`content_${d}`],onChange:t=>n(`content_${d}`,t||""),placeholder:g==="ko"?"내용을 입력하세요... (/ 를 누르면 메뉴가 나타납니다)":g==="ja"?"コンテンツを入力... (/でメニュー表示)":"Type your content... (Press / for menu)",height:500})]})]}),N&&e.jsx("div",{className:"text-red-500 bg-red-900/20 p-4 rounded-lg",children:N}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("button",{type:"submit",disabled:v,className:"px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-medium disabled:opacity-50",children:v?"...":s.submit}),e.jsx("button",{type:"button",onClick:()=>h(-1),className:"px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-md text-white font-medium",children:s.cancel})]})]})]})})]})};export{le as default};
